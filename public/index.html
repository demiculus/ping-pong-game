<!DOCTYPE html>
<html>
<head>
	<title>Ping Pong Game</title>
</head>
<body style="margin: 0;">
	<canvas id="canvas"></canvas>
	<script type="text/javascript" src="js/app.js"></script>
	<script type="text/javascript" src="js/gameState.js"></script>
	<script type="text/javascript">
		window.onload = function(){
			app.init();
			gameState.init();
		};

		const redPlate = 'red-plate'
		const blackPlate = 'blac-plate'
		const ball = 'ball'

		app.onInit = function(){
			window.addEventListener('keydown', function (e) {
				if(e.key == 'w') app.getNode(redPlate).y -= gameState.plateSpeed;
				if(e.key == 's') app.getNode(redPlate).y += gameState.plateSpeed;
				if(e.key == 'i') app.getNode(blackPlate).y -= gameState.plateSpeed;
				if(e.key == 'k') app.getNode(blackPlate).y += gameState.plateSpeed;
				if(e.key == 'r') app.onReset();
				if(e.keyCode == 32) gameState.pause = !gameState.pause;
			});
			app.onReset()
		};

		app.onUpdate = function(time){
			if(gameState.pause) return
			this.getNode(ball).x += gameState.ballXVelocity * gameState.ballSpeed
			this.getNode(ball).y += gameState.ballYVelocity * gameState.ballSpeed
			handleCollision()
		};

		app.onReset = function(){
			app.nodes = []
			gameState.pause = true

			const plateMargin = this.height/20
			const plateHeight = this.height/10
			const plateWidth = plateHeight / 5

			const ballSize = plateWidth

			gameState.plateSpeed = app.height/40
			gameState.ballSpeed = gameState.plateSpeed / 2
			gameState.ballXVelocity = Math.random() > 0.5 ? -1 : 1
			gameState.ballYVelocity = 0
			changeBallYVelocity()

			this.nodes.push({
				id : redPlate,
				x  : plateMargin,
				y  : this.height/2 - plateHeight/2,
				width  : plateWidth,
				height : plateHeight,
				color  : 'red',
				direction : 0
			});

			this.nodes.push({
				id : blackPlate,
				x  : this.width - plateMargin,
				y  : this.height/2 - plateHeight/2,
				width  : plateWidth,
				height : plateHeight,
				color  : 'black'
			});

			this.nodes.push({
				id : ball,
				x  : this.width/2 - ballSize/2,
				y  : this.height/2 - ballSize/2,
				width  : ballSize,
				height : ballSize,
				color  : 'purple'
			});
		}

		function changeBallYVelocity() {
			gameState.ballYVelocity += randomNumber(-0.3, 0.3)
		}

		function randomNumber(min, max) {
  			return Math.random() * (max - min) + min;
		}

		function handleCollision() {
			handleBallEdgeBounce()
			
			for(const node of app.nodes) {
				handleEdgeCollision(node)
				if(node.id == ball) continue
				if(detectCollision(node, app.getNode(ball))) {
					gameState.ballXVelocity *= -1
					changeBallYVelocity()
				}
			}
			handleWinConditions()
		}

		function handleBallEdgeBounce() {
			if(app.getNode(ball).y <= 0) gameState.ballYVelocity *= -1
			if(app.getNode(ball).y + app.getNode(ball).width >= app.height) gameState.ballYVelocity *= -1
		}

		function handleWinConditions() {
			if(app.getNode(ball).x <= 0) {
				app.onReset()
				gameState.blackScore += 1
				console.log('Black Won. Score: ' + gameState.blackScore)
			}
			if(app.getNode(ball).x + app.getNode(ball).width >= app.width) {
				app.onReset()
				gameState.redScore += 1
				console.log('Red Won. Score: ' + gameState.redScore)
			}
		}

		function handleEdgeCollision(rect) {
			if(rect.x <= 0) rect.x = 0
			if(rect.y <= 0) rect.y = 0
			if(rect.x + rect.width >= app.width) rect.x = app.width - rect.width
			if(rect.y + rect.height >= app.height) rect.y = app.height - rect.height
		}

		function detectCollision(rect1, rect2) {
			if (rect1.x < rect2.x + rect2.width &&
				rect1.x + rect1.width > rect2.x &&
				rect1.y < rect2.y + rect2.height &&
				rect1.y + rect1.height > rect2.y) {
				return true
			}
			return false
		}
	</script>
</body>
</html>